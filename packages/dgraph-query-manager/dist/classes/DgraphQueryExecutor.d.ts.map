{"version":3,"sources":["../packages/dgraph-query-manager/src/classes/DgraphQueryExecutor.ts"],"names":[],"mappings":"AAIA,OAAO,EAAE,aAAa,EAAE,MAAM,YAAY,CAAC;AAC3C,OAAO,EAAE,KAAK,EAAE,MAAM,SAAS,CAAC;AAMhC,MAAM,WAAW,4BAA4B;IAC3C,UAAU,EAAE,OAAO,CAAC;IACpB,MAAM,CAAC,EAAE,MAAM,CAAC;IAChB,KAAK,EAAE,KAAK,CAAC;IACb,OAAO,CAAC,EAAE,aAAa,CAAC;CACzB;AAED,oBAAY,wBAAwB;IAClC,KAAK,IAAA;IACL,aAAa,IAAA;IACb,IAAI,IAAA;IACJ,UAAU,IAAA;CACX;AAED,qBAAa,mBAAoB,YAAW,4BAA4B;IACtE,UAAU,UAAS;IACnB,MAAM,CAAC,EAAE,MAAM,CAAC;IAChB,KAAK,EAAE,KAAK,CAAC;IACb,OAAO,CAAC,EAAE,aAAa,CAAC;gBAGtB,KAAK,EAAE,KAAK,EACZ,MAAM,CAAC,EAAE,MAAM,EACf,UAAU,UAAQ,EAClB,OAAO,CAAC,EAAE,aAAa;IAWzB;;OAEG;IACG,OAAO,IAAI,OAAO,CAAC,aAAa,CAAC;IA8CvC;;;OAGG;IACG,iBAAiB,IAAI,OAAO,CAAC,aAAa,CAAC;IA+BjD;;;OAGG;IACG,oBAAoB,CAAC,OAAO,CAAC,EAAE,aAAa,GAAG,OAAO,CAAC,aAAa,CAAC;CAuB5E","file":"DgraphQueryExecutor.d.ts","sourcesContent":["import {\r\n  DgraphAdapterHttp,\r\n  DgraphAdapterHttp as DgraphAdapter\r\n} from '../adapters';\r\nimport { Serialization } from '../classes';\r\nimport { Query } from './Query';\r\nimport logger from '../logger';\r\nimport axios from 'axios';\r\nimport config from '../config';\r\nimport { DgraphConnectionType } from '../config/development';\r\n\r\nexport interface DgraphQueryExecutorInterface {\r\n  isMutation: boolean;\r\n  params?: object;\r\n  query: Query;\r\n  request?: Serialization;\r\n}\r\n\r\nexport enum DgraphQueryExecutorModes {\r\n  Query,\r\n  QueryWithVars,\r\n  Json,\r\n  DeleteJson\r\n}\r\n\r\nexport class DgraphQueryExecutor implements DgraphQueryExecutorInterface {\r\n  isMutation = false;\r\n  params?: object;\r\n  query: Query;\r\n  request?: Serialization;\r\n\r\n  constructor(\r\n    query: Query,\r\n    params?: object,\r\n    isMutation = false,\r\n    request?: Serialization\r\n  ) {\r\n    this.isMutation = isMutation;\r\n    this.params = params;\r\n    this.query = query;\r\n    this.request = request;\r\n    if (query.validateParams(params)) {\r\n      query.injectCustomParams(params);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Execute Dgraph query based on instance properties and configuration.\r\n   */\r\n  async execute(): Promise<Serialization> {\r\n    let serialization;\r\n    if (config.connectionType === DgraphConnectionType.API) {\r\n      serialization = await this.executeApiRequest();\r\n    } else {\r\n      // Default to direct.\r\n      serialization = await this.executeDirectRequest(this.request);\r\n    }\r\n\r\n    // Assume singular array of 'data' if not included.\r\n    const tree =\r\n      this.query.tree && this.query.tree.length > 0\r\n        ? this.query.tree\r\n        : new Array(['data']);\r\n\r\n    if (serialization.response) {\r\n      let combinedResponse: any[] = [];\r\n      for (const branch of tree) {\r\n        let branchResponse = serialization.response;\r\n        for (const stick of branch) {\r\n          if (branchResponse[stick]) {\r\n            branchResponse = branchResponse[stick];\r\n          }\r\n        }\r\n        // Combines all previous arrays with new response array to generate full result set.\r\n        combinedResponse = combinedResponse.concat(branchResponse);\r\n      }\r\n      serialization.message = `No ${this.query.objectType} found.`;\r\n\r\n      // Flatten arrays\r\n      serialization.response = DgraphAdapterHttp.flattenArrays(\r\n        combinedResponse ? combinedResponse : serialization.response\r\n      );\r\n      if (\r\n        !Array.isArray(serialization.response) ||\r\n        (Array.isArray(serialization.response) &&\r\n          serialization.response.length > 0)\r\n      ) {\r\n        serialization.message = `${this.query.objectType} found.`;\r\n        serialization.success = true;\r\n      }\r\n    }\r\n\r\n    return serialization;\r\n  }\r\n\r\n  /**\r\n   * Makes an API query request.\r\n   * @param request\r\n   */\r\n  async executeApiRequest(): Promise<Serialization> {\r\n    const response = new Serialization({\r\n      message: `Failed to retrieve ${this.query.objectType} via API request.`,\r\n      request: this.query.query\r\n    });\r\n\r\n    // Get URL\r\n    const url = `${config.dgraph.api.protocol}://${config.dgraph.api.host}:${\r\n      config.dgraph.api.port\r\n    }/api/${this.query.uri(this.params)}`;\r\n\r\n    // TODO: Change HTTP verb dynamically based on Query.\r\n    axios\r\n      .get(url)\r\n      .then(axiosResponse => {\r\n        logger.info(\r\n          `DgraphQueryExecutor.executeDirect response %o`,\r\n          axiosResponse.data.response\r\n        );\r\n        response.response = axiosResponse.data.response;\r\n        return response;\r\n      })\r\n      .catch(exception => {\r\n        logger.error(exception);\r\n        response.error = exception;\r\n        return response;\r\n      });\r\n\r\n    return response;\r\n  }\r\n\r\n  /**\r\n   * Makes a direct request.\r\n   * @param request\r\n   */\r\n  async executeDirectRequest(request?: Serialization): Promise<Serialization> {\r\n    const adapter = new DgraphAdapter();\r\n    let response = new Serialization({\r\n      message: `Failed to retrieve ${\r\n        this.query.objectType\r\n      } via direct request.`,\r\n      request: this.query.query\r\n    });\r\n\r\n    // Allow request to be optionally passed.\r\n    request = request ? request : response;\r\n\r\n    if (this.isMutation) {\r\n      response = await adapter.mutate(request);\r\n    } else {\r\n      if (this.query.paramTypes) {\r\n        response = await adapter.queryWithVars(request, this.query.params);\r\n      } else {\r\n        response = await adapter.query(request);\r\n      }\r\n    }\r\n    return response;\r\n  }\r\n}\r\n"]}