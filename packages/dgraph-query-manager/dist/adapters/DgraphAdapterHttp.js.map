{"version":3,"sources":["../packages/dgraph-query-manager/src/adapters/DgraphAdapterHttp.ts"],"names":[],"mappings":"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","file":"DgraphAdapterHttp.js","sourcesContent":["// Lib\r\nimport { DgraphClient, DgraphClientStub } from 'dgraph-js-http';\r\n// Local\r\nimport config from '../config';\r\nimport logger from '../logger';\r\nimport { MutationTypes } from './MutationTypes';\r\nimport { Serialization } from '../classes';\r\n\r\nexport class DgraphAdapterHttp {\r\n  /**\r\n   * Endpoint address of Dgraph server.\r\n   */\r\n  address = config.dgraph.adapter.address;\r\n\r\n  /**\r\n   * Dgraph client.\r\n   */\r\n  protected client: NonNullable<DgraphClient>;\r\n\r\n  /**\r\n   * Dgraph client stub.\r\n   */\r\n  protected clientStub: NonNullable<DgraphClientStub>;\r\n\r\n  constructor(address?: string) {\r\n    if (address) this.address = address;\r\n    this.clientStub = new DgraphClientStub(this.address);\r\n    this.client = new DgraphClient(this.clientStub);\r\n  }\r\n\r\n  /**\r\n   * Alter the database schema.\r\n   * @param {string} schema\r\n   * @returns {Promise<boolean>}\r\n   */\r\n  async alterSchema(schema: string): Promise<boolean> {\r\n    return this.client\r\n      .alter({ schema })\r\n      .then(() => {\r\n        logger.info(`Dgraph schema altered: %s`, schema);\r\n        return true;\r\n      })\r\n      .catch(error => {\r\n        logger.error(`Dgraph schema alteration failed, error: %s`, error);\r\n        return false;\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Drop all database data.\r\n   * @returns {Promise<boolean>}\r\n   */\r\n  async dropAll(): Promise<boolean> {\r\n    const result = await this.client\r\n      .alter({ dropAll: true })\r\n      .then(() => {\r\n        logger.info(`All Dgraph data dropped.`);\r\n        return true;\r\n      })\r\n      .catch(error => {\r\n        logger.error(`Dgraph data drop failed, error: %s`, error);\r\n        return false;\r\n      });\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Recursively flattens arrays within passed object.\r\n   * Sets object key value pointing to a single-element array to value of that only element.\r\n   * @param {object} obj\r\n   * @returns {any}\r\n   */\r\n  static flattenArrays(obj: any) {\r\n    let copy: any = obj;\r\n    if (Array.isArray(obj) && obj.length === 1) {\r\n      copy = DgraphAdapterHttp.flattenArrays(copy[0]);\r\n    } else if (Array.isArray(obj)) {\r\n      obj.forEach((value, key) => {\r\n        copy[key] = DgraphAdapterHttp.flattenArrays(value);\r\n      });\r\n    } else {\r\n      for (const key in obj) {\r\n        if (obj.hasOwnProperty(key)) {\r\n          if (Array.isArray(obj[key]) && obj[key].length === 1) {\r\n            // Set keyvalue to first (and only) array value.\r\n            copy[key] = DgraphAdapterHttp.flattenArrays(obj[key][0]);\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return copy;\r\n  }\r\n\r\n  static flattenArraysInObject(obj) {\r\n    const copy: any = obj;\r\n    Object.entries(obj).forEach(([key, value]) => {\r\n      if (obj.hasOwnProperty(key)) {\r\n        if (Array.isArray(value)) {\r\n          if (value.length === 1) {\r\n            // Set keyvalue to first (and only) array value.\r\n            copy[key] = DgraphAdapterHttp.flattenArraysInObject(value[0]);\r\n          } else {\r\n            // Retain original array\r\n            copy[key] = DgraphAdapterHttp.flattenArraysInObject(value);\r\n          }\r\n        } else {\r\n          copy[key] = DgraphAdapterHttp.flattenArraysInObject(value);\r\n        }\r\n      }\r\n    });\r\n    return copy;\r\n  }\r\n\r\n  /**\r\n   * Execute a database mutation using passed payload object or BaseModel<T> instance.\r\n   * @param {Serialization} serialization\r\n   * @param {MutationTypes} mutationType\r\n   * @param {boolean} commitNow\r\n   * @returns {Promise<Partial<T>>}\r\n   */\r\n  async mutate<T>(\r\n    serialization: Serialization,\r\n    mutationType: MutationTypes = MutationTypes.SetJson,\r\n    commitNow = false\r\n  ): Promise<Serialization> {\r\n    if (serialization.request === undefined) {\r\n      throw Error(\r\n        `DgraphAdapterHttp.mutate error, payload undefined for data: ${\r\n          serialization.data\r\n        }`\r\n      );\r\n    }\r\n    const transaction = this.client.newTxn();\r\n    const uids: string[] = [];\r\n    logger.debug('DgraphAdapterHttp.mutate, payload: %o', serialization);\r\n    try {\r\n      const payload: any = {};\r\n      payload.commitNow = commitNow;\r\n      switch (mutationType) {\r\n        case MutationTypes.SetJson:\r\n          payload.setJson = serialization.request;\r\n          break;\r\n        case MutationTypes.DeleteJson:\r\n          payload.deleteJson = serialization.request;\r\n          break;\r\n      }\r\n      const assigned = await transaction.mutate(payload);\r\n      if (!commitNow) await transaction.commit();\r\n      Object.entries(assigned.data.uids).forEach(([key, uid]) =>\r\n        uids.push(uid)\r\n      );\r\n    } catch (e) {\r\n      logger.error(\r\n        'DgraphAdapterHttp.mutate, payload: %o, mutationType: %o, error: %o',\r\n        serialization,\r\n        mutationType,\r\n        e\r\n      );\r\n    } finally {\r\n      await transaction.discard();\r\n    }\r\n    // Assign generated uids\r\n    if (uids.length > 0) serialization.uid = uids;\r\n    return serialization;\r\n  }\r\n\r\n  /**\r\n   * Execute a database query.\r\n   * @param {string} serialization\r\n   * @returns {Promise<string>}\r\n   */\r\n  async query<T>(serialization: Serialization): Promise<Serialization> {\r\n    const transaction = this.client.newTxn();\r\n    try {\r\n      const res = await transaction.query(serialization.request);\r\n      serialization.response = DgraphAdapterHttp.flattenArrays(res.data);\r\n    } catch (e) {\r\n      logger.error('DgraphAdapterHttp.query, error: %o', e);\r\n    } finally {\r\n      await transaction.discard();\r\n    }\r\n    return serialization;\r\n  }\r\n\r\n  /**\r\n   * Execute a database query with paramTypes.\r\n   * @param {string} serialization\r\n   * @param vars\r\n   * @returns {Promise<any>}\r\n   */\r\n  async queryWithVars(\r\n    serialization: Serialization,\r\n    vars?: any\r\n  ): Promise<Serialization> {\r\n    const transaction = this.client.newTxn();\r\n    try {\r\n      const res = await transaction.queryWithVars(serialization.request, vars);\r\n      serialization.response = DgraphAdapterHttp.flattenArrays(res.data);\r\n    } catch (e) {\r\n      logger.error(\r\n        'DgraphAdapterHttp.queryWithVars, query: %s, paramTypes: %o, error: %o',\r\n        serialization,\r\n        vars,\r\n        e\r\n      );\r\n    } finally {\r\n      await transaction.discard();\r\n    }\r\n    return serialization;\r\n  }\r\n}\r\n"]}